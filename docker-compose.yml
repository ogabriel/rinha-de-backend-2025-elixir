services:
  nginx:
    image: nginx:mainline-alpine3.22
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    command: ["nginx", "-g", "daemon off;"]
    ports:
      - 9999:9999
    networks:
      - backend
    depends_on:
      - app1
      - app2
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: '50MB'

  app1: &app1
    build:
      context: .
      dockerfile: Dockerfile
      target: release
    environment: &env_app1
      MIX_ENV: prod
      ERL_MAX_PORTS: 4096
      RELEASE_DISTRIBUTION: name
      RELEASE_NODE: app@app1.com
      RELEASE_COOKIE: rinha
      CONNECT_TO_NODE: app@app2.com
    hostname: app1.com
    command: ["migrate_and_release"]
    networks:
      - backend
      - payment-processor
    deploy:
      resources:
        limits:
          cpus: '0.65'
          memory: '150MB'

  app2:
    <<: *app1
    depends_on:
      - app1
    environment:
      <<: *env_app1
      RELEASE_NODE: app@app2.com
    hostname: app2.com
    command: ["release"]

networks:
  backend:
    driver: bridge
  payment-processor:
    external: true
